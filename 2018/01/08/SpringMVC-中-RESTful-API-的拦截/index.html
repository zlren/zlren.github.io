<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SpringMVC 中 RESTful API 的拦截 | zlren</title>

  
  <meta name="author" content="任子龙">
  

  
  <meta name="description" content="很多时候我们需要对每个 url 请求进行统一处理，比如记录每个 url 从开始请求到业务完成并返回所花费的时间，这需要在 url 请求到来的时候记录下来时间戳，完成后再记录下时间，二者的时间差值便是执行这次请求花费的时间。本篇以 SpringMVC 为例来讲解一下其中的三种拦截机制，他们分别是过滤器（Filter）、拦截器（Interceptor）和切片（Aspect）">
  

  
  
  <meta name="keywords" content="rest">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="SpringMVC 中 RESTful API 的拦截"/>

  <meta property="og:site_name" content="zlren"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="zlren" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">zlren</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>SpringMVC 中 RESTful API 的拦截</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/01/08/SpringMVC-中-RESTful-API-的拦截/" rel="bookmark">
        <time class="entry-date published" datetime="2018-01-08T11:32:14.000Z">
          2018-01-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>很多时候我们需要对每个 url 请求进行统一处理，比如记录每个 url 从开始请求到业务完成并返回所花费的时间，这需要在 url 请求到来的时候记录下来时间戳，完成后再记录下时间，二者的时间差值便是执行这次请求花费的时间。本篇以 SpringMVC 为例来讲解一下其中的三种拦截机制，他们分别是过滤器（Filter）、拦截器（Interceptor）和切片（Aspect）</p>
<a id="more"></a>
<h4 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h4><p>初始项目如下，新建一个 maven 工程，pom 中添加 SpringBoot 的 parent 标签，这里使用的 1.5.7.RELEASE 版本。依赖中只添加了 web，也就是 SpringMVC</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>新建启动类，置于 lab.zlren.demo 包下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建一个 Controller 用于演示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动工程，执行 main 方法，访问 localhost:8080/demo，可以看到如下效果表明基础环境已经搭建完成</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fluehwpfm6j30p30hhaao.jpg" alt=""></p>
<h4 id="过滤器-Filter"><a href="#过滤器-Filter" class="headerlink" title="过滤器 Filter"></a>过滤器 Filter</h4><p>新建 package：lab.zlren.demo.filter，在这个包下新建一个类叫做 TimeFilter，要继承 javax.servlet.Filter 这个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lab.zlren.demo.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zlren</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017-11-25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"TimeFilter init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">            IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"TimeFilter start"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis();</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>, System.currentTimeMillis() - time);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"TimeFilter finish"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"TimeFilter destroy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里非常简单，在 doFilter 方法中记录下前后的时间戳，中间执行业务的逻辑就是用过滤器链继续调用就可以。在 SpringBoot 中使它生效很容易，只需要将其声明为一个 Component 即可</p>
<p>做好以后重启服务，再次访问 localhost:8080/demo，查看控制台的日志打印</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fluevtj0gkj31kw0mpe81.jpg" alt=""></p>
<p>可以看到在系统启动过程中便执行了 init 方法，访问 url 的前后分别打印了 start 和 finish 语句，并记录下了耗时。这样一个简答的过滤器就完成了。</p>
<p>这里补充一下，TimeFilter 是我们自己开发的过滤器，我们为其加上 @Component 注解就可以使之生效。很多时候我们需要使用第三方的 Filter，如果这些 Filter 没有加注解那么如何使之生效呢？</p>
<p>SpringBoot 颠覆了传统的 web 开发，其中一个表现就是没有了 web.xml，所以也没法在 web.xml 中进行配置。这里我们需要这样做：首先去掉 @Component 注解，现在将 TimeFilter 当做一个第三方的过滤器。在 filter 包下新建一个类叫做 WebConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lab.zlren.demo.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zlren</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017-11-25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">timeFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean registrationBean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        TimeFilter timeFilter = <span class="keyword">new</span> TimeFilter();</span><br><span class="line">        registrationBean.setFilter(timeFilter);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; urls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        urls.add(<span class="string">"/*"</span>);</span><br><span class="line">        registrationBean.setUrlPatterns(urls);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实这样写和传统的在 web.xml 中配置是一样的，可以看到这样写的情况下还可以配置 TimeFilter 这个过滤器在哪些 url 中起作用。配置完成后重启服务，和刚刚的效果是一致的</p>
<p>在 Filter 中我们只能拿到请求的 request 和 response，但是这个请求到底交由哪个 Controller 的哪个方法去处理我们是不知道的。Filter 的接口是 j2ee 的规范来定义的，而它并不了解 SpringMVC 中的具体实现。如果需要拿到处理这个请求的具体的方法，我们需要使用 Interceptor</p>
<h4 id="拦截器-Interceptor"><a href="#拦截器-Interceptor" class="headerlink" title="拦截器 Interceptor"></a>拦截器 Interceptor</h4><p>新建 package：lab.zlren.demo.interceptor，在这个包下新建一个类叫做 TimeInterceptor，它需要实现的接口是 org.springframework.web.servlet.HandlerInterceptor。这个接口下有 3 个方法分别是 preHandle、postHandle 和 afterCompletion，其中 pre 和 post 就是在 Controller 中的方法被调用的前后分别执行的。需要注意的是，如果在 Controller 的方法中抛出了异常，post 就不会被调用了，但是无论异常与否 after 都是会被调用的。</p>
<p>在 Filter 中，我们可以在一个方法也就是 doFilter 中完成前后时间的记录并计算时间差值，这里拦截器有两个方法，所以需要在 request 中设置 key-value 的形式记录并传值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lab.zlren.demo.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.HandlerMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zlren</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017-11-25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object handler)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">            Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"preHandle"</span>);</span><br><span class="line">        httpServletRequest.setAttribute(<span class="string">"START_TIME"</span>, System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里打印了controller方法的类名和方法名</span></span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>, ((HandlerMethod) handler).getBean().getClass().getName());</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>, ((HandlerMethod) handler).getMethod().getName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o,</span></span></span><br><span class="line"><span class="function"><span class="params">                           ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"postHandle"</span>);</span><br><span class="line">        <span class="keyword">long</span> startTime = (<span class="keyword">long</span>) httpServletRequest.getAttribute(<span class="string">"START_TIME"</span>);</span><br><span class="line">        log.info(<span class="string">"耗时：&#123;&#125;"</span>, System.currentTimeMillis() - startTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"afterCompletion"</span>);</span><br><span class="line">        <span class="keyword">long</span> startTime = (<span class="keyword">long</span>) httpServletRequest.getAttribute(<span class="string">"START_TIME"</span>);</span><br><span class="line">        log.info(<span class="string">"耗时：&#123;&#125;"</span>, System.currentTimeMillis() - startTime);</span><br><span class="line">        log.error(<span class="string">"&#123;&#125;"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pre 方法中除了记录起始时间外还通过第三个参数拿到了被调用的 Controller 方法的具体信息，这也是它的优势。另外 post 和 after 方法都记录了时间，读者可以在 Controller 中尝试抛异常与不抛异常两种情况下查看日志的打印情况</p>
<p>Interceptor 只声明为 Component 还不够，为了让它生效我们需要改写之前写的 WebConfig，将其继承 org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter，并覆盖它的 addInterceptors 方法。这样一来就可以生效了，读者可以进行测试，这里只给出了正常情况下的 log 打印情况</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fluggyjt9gj30pw04rabn.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lab.zlren.demo.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lab.zlren.demo.interceptor.TimeInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zlren</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017-11-25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TimeInterceptor timeInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(timeInterceptor);</span><br><span class="line">        <span class="keyword">super</span>.addInterceptors(registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Bean</span></span><br><span class="line">    <span class="comment">// public FilterRegistrationBean timeFilter() &#123;</span></span><br><span class="line">    <span class="comment">//     FilterRegistrationBean registrationBean = new FilterRegistrationBean();</span></span><br><span class="line">    <span class="comment">//     TimeFilter timeFilter = new TimeFilter();</span></span><br><span class="line">    <span class="comment">//     registrationBean.setFilter(timeFilter);</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     List&lt;String&gt; urls = new ArrayList&lt;&gt;();</span></span><br><span class="line">    <span class="comment">//     urls.add("/*");</span></span><br><span class="line">    <span class="comment">//     registrationBean.setUrlPatterns(urls);</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     return registrationBean;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Interceptor 相比 Filter 可以拿到具体处理业务的方法的 Controller 和方法名，它还有一个不足，那就是拿不到这个方法的参数值（通过分析 SpringMVC 的源码可以看到拼接参数值的操作在 pre 之后），如果想拿到参数值会怎么样呢？这里就要使用切片（Aspect）了</p>
<h4 id="切片-Aspect"><a href="#切片-Aspect" class="headerlink" title="切片 Aspect"></a>切片 Aspect</h4><p>什么是切片？这是 Spring 的核心功能之一（另一个是 IoC）。所谓切片实际上就是一个类，什么样的类可以称作是一个 Aspect 呢？需要具备以下两个条件</p>
<ul>
<li>切入点：使用注解进行配置，它决定了这个切片在哪些方法上起作用以及在什么时候起作用</li>
<li>增强：听着这么不沾边实际上它就是一个方法，定义了起作用的时候的具体要执行的业务逻辑</li>
</ul>
<p>开始前需要引入 aop 的依赖，在 pom.xml 中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>同样我们新建一个 package 叫做 aspect，在这个包下新建一个类叫做 TimeAspect。在什么时候起作用的配置是由我们使用的注解来确定的，相关的注解有 4 个：@Before、@After、@AfterThrowing 以及 @Around，其中前三个对比 Interceptor 很容易理解，最后一个 Around 包含了上述三种情况，一般情况下我们自定义切片使用 Around 即可。如何定义在哪些方法上起作用？这是由表达式来决定的，这里不作具体的描述，可以参考<a href="https://docs.spring.io/spring/docs/4.3.12.RELEASE/spring-framework-reference/htmlsingle/#aop" target="_blank" rel="noopener">这里</a></p>
<p>这里为了可以拿到 Controller 方法里面的参数我们对 demo 方法进行简单的改造，为其加上参数（name）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">(@RequestParam String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello world"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lab.zlren.demo.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zlren</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017-11-25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"execution(* lab.zlren.demo.controller.DemoController.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">handleControllerMethod</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"TimeAspect start"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法参数</span></span><br><span class="line">        Object[] args = proceedingJoinPoint.getArgs();</span><br><span class="line">        <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">            log.info(<span class="string">"arg is &#123;&#125;"</span>, arg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行被拦截的方法并拿到返回值</span></span><br><span class="line">        Object o = proceedingJoinPoint.proceed();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"TimeAspect end：&#123;&#125;"</span>, System.currentTimeMillis() - startTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>响应的访问的 url 也进行了简单的调整，加上 name 参数：localhost:8080/demo?name=zhangsan。可以看到控制台中已经打印出了此次请求携带的具体参数的信息</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fluhnyojc0j30pu03oabe.jpg" alt=""></p>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>上面的三种拦截机制我们进行了初步的了解，它们各有各的优势和不足：Interceptor 相比 Filter 可以拿到具体的方法，Aspect 相比 Interceptor 可以拿到具体的参数信息</p>
<p>实际上在上面的过程中我同一时刻只允许一种机制生效，如果把上面的三种拦截机制都打开，他们会同时生效吗？会发生冲突导致异常吗？他们的执行顺序是怎么样的？有兴趣的读者可以进行进一步的探索</p>
<blockquote>
<p>这里告诉大家它们的执行顺序是 Filter -&gt; Interceptor -&gt; Aspect，而在 Controller 的方法中如果出现了异常，捕获的顺序和这里是相反的。实际上在 Interceptor 和 Aspect 中间还有一层叫做 ControllerAdvice，它是什么？留给读者思考</p>
</blockquote>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/rest/">rest</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 任子龙
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>